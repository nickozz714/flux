<!doctype html>
<meta charset="utf-8">
<title>Flux Web</title>
<style>
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; margin:2rem; line-height:1.4}
  input,select,button,textarea{font:inherit}
  pre{background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto;max-height:45vh}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{border:1px solid #ddd;padding:12px;border-radius:10px;margin:12px 0}
</style>
<h1>Flux Web</h1>
<div class="card">
  <div class="row">
    <button id="load">Load Catalog</button>
    <input id="token" placeholder="Token (from /etc/flux-web/config.json)" size="48">
  </div>
  <div class="row">
    <select id="cmd"></select>
    <button id="run">Run</button>
  </div>
  <div id="args" class="row"></div>
</div>
<div class="card">
  <h3>Result</h3>
  <pre id="out"></pre>
</div>
<script>
  const el = (id)=>document.getElementById(id);
  const out = el('out');
  const cmdSel = el('cmd');
  const argsDiv = el('args');
  let catalog = null;

  function bearer() {
    const t = el('token').value.trim();
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  }

  async function loadCatalog() {
    out.textContent = 'Loading catalog...';
    const r = await fetch('/api/catalog', { headers: bearer() });
    if (!r.ok) { out.textContent = 'Error: ' + r.status + ' ' + await r.text(); return; }
    const data = await r.json();
    catalog = data;
    cmdSel.innerHTML = '';
    for (const c of data.commands) {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.id + ' â€” ' + c.desc;
      cmdSel.appendChild(opt);
    }
    out.textContent = 'Catalog loaded: ' + data.commands.length + ' commands';
    renderArgs();
  }

  function renderArgs() {
    argsDiv.innerHTML = '';
    const id = cmdSel.value;
    const entry = catalog.commands.find(c=>c.id===id);
    if (!entry) return;
    for (const a of (entry.args||[])) {
      if (a.type === 'const') continue;
      const inp = document.createElement('input');
      inp.placeholder = a.name + (a.required ? ' *' : '');
      inp.dataset.name = a.name;
      argsDiv.appendChild(inp);
    }
  }

  async function runCmd() {
    const id = cmdSel.value;
    const entry = catalog.commands.find(c=>c.id===id);
    const args = {};
    for (const inp of argsDiv.querySelectorAll('input')) {
      if (inp.value) args[inp.dataset.name] = inp.value;
    }
    out.textContent = 'Running...';
    const r = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...bearer() },
      body: JSON.stringify({ id, args })
    });
    const data = await r.json();
    out.textContent = JSON.stringify(data, null, 2);
  }

  el('load').onclick = loadCatalog;
  el('cmd').onchange = renderArgs;
  el('run').onclick = runCmd;
</script>
